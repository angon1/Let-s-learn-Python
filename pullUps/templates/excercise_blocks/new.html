{% extends '../layout.html' %}

{% block content %}
<script type="text/javascript" >
    localStorage.setItem("blockCount",0)
    localStorage.setItem("setCount",0)

    let saveAll = (url) =>
    {
        localStorage.removeItem("blockCount")
        localStorage.removeItem("setCount")
        document.getElementById("blockForm").submit()
    }

    let editSetSelect = () =>
    {
        let blockCount = localStorage.getItem("blockCount")
        let selectDiv = window.document.getElementById(`blockSubForm-${blockCount}`)
        let divChildNodes = selectDiv.children
        for (const node of divChildNodes) {
            console.log("node = " , node)
            console.log("node-type = ", node.type)
            if( "select-multiple" === node.type)
            {
                node.removeAttribute("multiple")
                break
            }
        }
        console.log("selectDiv.firstElementChild = " , divChildNodes)
    }

    let requestForm = async (url) =>
    {
        return fetch(url).then(response => response.text())
    }

    let addExistingSet = async (url) =>
    {
        let blockCount = localStorage.getItem("blockCount")
        blockCount++
        localStorage.setItem("blockCount",blockCount)
        let new_div = document.createElement("div")
        new_div.classList.add("post-form")
        new_div.setAttribute("href", url)
        new_div.setAttribute("id", `blockSubForm-${blockCount}` )
        let block_root = window.document.getElementById("allSets")
        new_div.innerHTML = await requestForm(url)
        setTimeout(editSetSelect, 1)
        block_root.append(new_div)
    }


    let createSet = (url) =>
    {
        const Http = new XMLHttpRequest();
        let new_div = document.createElement("div")
        new_div.classList.add("post-form")
        new_div.setAttribute("href", url)
        new_div.setAttribute("id", "setForm")
        let block_root = window.document.getElementById("allSets")
        console.log(url)
        Http.open("GET", url);
        Http.send();

        Http.onreadystatechange = (e) => {
            console.log(Http.responseText)
            new_div.innerHTML=Http.responseText
        }
        block_root.append(new_div)

    }
</script>



<div id="blockRoot">
    <h2>Dodaj sety do bloku</h2>
    <form id="blockForm" method="POST" action="{% url 'excercise_blocks_create' %}" class="post-form">{% csrf_token %}
        Przerwa po bloku: <br />
        {{ form.breakTimeAfterBlock}} <br />

        <div id="allSets"></div>
        <div id="addExistingSet" onclick="addExistingSet('{% url 'excercise_blocks_newForm' %}')">+dodaj set</div>
        <div onclick="createSet('{% url 'excercise_sets_newForm' %}')"> +stw√≥rz nowy set</div>
        <button type="button" onclick="saveAll('{% url 'excercise_sets_create' %}')" class="save btn btn-default">Zapisz blok</button>
    </form>
</div>

{% endblock %}
